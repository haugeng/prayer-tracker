<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Prayer Tracker</title>
    <style>
        :root {
            --bg: #121212; --card: #1e1e1e; --text: #e0e0e0;
            --accent: #bb86fc; --success: #03dac6; --error: #cf6679;
        }
        body {
            font-family: -apple-system, system-ui, sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center;
        }
        .container { width: 100%; max-width: 500px; padding-bottom: 50px; }
        
        /* Headers & Nav */
        .header { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .help-icon { 
            background: #333; color: var(--text); width: 32px; height: 32px; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-weight: bold; cursor: pointer; border: 1px solid #444; font-size: 18px;
        }
        .nav { display: flex; width: 100%; gap: 8px; margin-bottom: 20px; position: sticky; top: 0; background: var(--bg); z-index: 10; padding: 5px 0; }
        .nav button { flex: 1; padding: 12px 5px; font-size: 14px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
        .nav .active { background: var(--accent); color: #000; }
        .secondary { background: #2a2a2a; color: white; }

        h3 { border-bottom: 1px solid #333; padding-bottom: 8px; margin-top: 10px; font-size: 1.1rem; }
        textarea, input {
            width: 100%; background: var(--card); color: var(--text);
            border: 1px solid #444; border-radius: 12px; padding: 14px;
            box-sizing: border-box; font-size: 16px; margin-bottom: 12px;
        }
        #main-pointers { height: 264px; resize: none; line-height: 1.5; }
        #manual-pointers { height: 180px; resize: none; }

        /* Timer UI */
        .timer-box {
            background: linear-gradient(145deg, #1e1e1e, #222);
            padding: 30px 20px; border-radius: 20px; text-align: center;
            margin: 15px 0; border: 1px solid #333;
        }
        #display-time { font-size: 3.5rem; font-weight: bold; font-family: monospace; color: var(--accent); }
        .btn { border: none; font-weight: bold; cursor: pointer; padding: 15px; border-radius: 12px; }
        .primary { background: var(--accent); color: #000; }
        .stop { background: var(--error); color: white; }
        .success { background: var(--success); color: #000; }
        .full-width { width: 100%; margin-top: 10px; }

        /* Dashboard */
        .dash-card { background: var(--card); border-radius: 15px; padding: 15px; margin-bottom: 10px; border: 1px solid #333; }
        .dash-main { display: flex; justify-content: space-around; align-items: center; margin-bottom: 15px; }
        .dash-item { text-align: center; flex: 1; }
        .dash-val { display: block; font-size: 1.4rem; font-weight: bold; color: var(--accent); white-space: nowrap; }
        .dash-lbl { font-size: 0.65rem; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; display: block; }
        .dash-footer { display: flex; justify-content: space-between; padding-top: 10px; border-top: 1px solid #333; font-size: 0.75rem; color: #666; }

        /* UX Indicators */
        .clickable-item { text-decoration: underline dashed var(--accent); text-underline-offset: 4px; cursor: pointer; }
        .chevron { display: inline-block; margin-right: 10px; transition: transform 0.2s ease; color: var(--accent); font-size: 0.8rem; }
        .expanded .chevron { transform: rotate(90deg); }
        .ghost-input { position: absolute; opacity: 0; width: 0; height: 0; pointer-events: none; }

        .admin-toggle { background: transparent; color: #888; border: 1px solid #333; border-radius: 8px; padding: 8px; font-size: 0.75rem; width: 100%; cursor: pointer; margin-bottom: 10px; }
        #admin-tools { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px; }
        #admin-tools.open { max-height: 300px; padding-bottom: 10px; border-bottom: 1px solid #333; }

        .year-head { font-size: 1.3rem; font-weight: bold; color: var(--accent); margin: 20px 0 5px 0; }
        .month-head { font-size: 0.85rem; color: #888; text-transform: uppercase; margin: 10px 0 5px 0; border-bottom: 1px solid #222; padding-bottom: 4px; }

        /* Recovery UI */
        #recovery-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .recovery-card { background: var(--card); padding: 25px; border-radius: 20px; border: 1px solid var(--accent); text-align: center; max-width: 400px; width: 100%; }

        /* History List Styles */
        .history-day-group { border-bottom: 1px solid #222; }
        .day-summary { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; cursor: pointer; }
        .sessions-container { max-height: 0; overflow: hidden; transition: all 0.3s ease; background: #161616; border-radius: 10px; }
        .sessions-container.expanded { max-height: 2000px; padding: 10px; margin-bottom: 15px; border: 1px solid #333; }
        .session-item { border-bottom: 1px solid #222; padding: 12px 0; }
        .session-item:last-child { border-bottom: none; }
        .session-meta { display: flex; justify-content: space-between; font-size: 0.75rem; color: #888; margin-bottom: 8px; }
        .editable-text { white-space: pre-wrap; color: #ccc; outline: none; font-style: italic; line-height: 1.6; font-size: 14px; width: 100%; display: block; }
        
        .action-bar { display: flex; gap: 10px; margin-top: 10px; }
        .action-btn { background: #333; color: #eee; font-size: 11px; padding: 6px 10px; border-radius: 4px; border: none; cursor: pointer; }
        .verse-footer { margin-top: 30px; text-align: center; font-size: 0.8rem; color: #555; font-style: italic; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="recovery-overlay" class="hidden">
    <div class="recovery-card">
        <h2 style="color: var(--accent); margin-top: 0;">Unfinished Session</h2>
        <p style="margin-bottom: 5px;">A session was found:</p>
        <div id="recovery-timestamp" style="font-size: 0.85rem; color: #888; margin-bottom: 15px;">Started: --:--</div>
        <div id="recovery-details" style="font-family: monospace; color: var(--success); margin: 15px 0; font-size: 1.5rem;">00:00:00</div>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <button class="btn primary" onclick="handleRecovery('resume')">Resume & Catch Up</button>
            <button class="btn success" onclick="handleRecovery('save')">Save to History</button>
            <button class="btn secondary" style="background: #422;" onclick="handleRecovery('discard')">Discard Session</button>
        </div>
    </div>
</div>

<div class="container">
    <div class="header">
        <h2 style="margin: 0; font-size: 1.3rem;">My Prayer Tracker</h2>
        <div class="help-icon" onclick="showPage('about')">?</div>
    </div>

    <div class="nav">
        <button id="nav-setup" class="secondary active" onclick="showPage('setup')">Timer</button>
        <button id="nav-manual" class="secondary" onclick="showPage('manual')">Log</button>
        <button id="nav-history" class="secondary" onclick="showPage('history')">History</button>
    </div>

    <div id="setup-page">
        <h3>Prayer & Reflections</h3>
        <textarea id="main-pointers" placeholder="Enter reflections here..."></textarea>
        <div class="timer-box">
            <div id="display-time">00:00:00</div>
            <p id="session-status" style="color: #666; margin: 10px 0; font-size: 0.9rem;">Ready</p>
            <div style="display: flex; justify-content: center; gap: 10px;">
                <button id="start-btn" class="btn primary" style="padding: 15px 25px;" onclick="startSession()">Start Prayer</button>
                <button id="pause-btn" class="btn secondary hidden" onclick="togglePause()">Pause</button>
                <button id="stop-btn" class="btn stop hidden" onclick="stopSession()">End</button>
            </div>
        </div>
        <div class="verse-footer">"Pray without ceasing." ‚Äî 1 Thess 5:17</div>
    </div>

    <div id="manual-page" class="hidden">
        <h3>Manual Entry</h3>
        <div style="background: #1a1a1a; padding: 20px; border-radius: 15px; border: 1px solid #333;">
            <label style="font-size: 0.7rem; color: var(--accent); font-weight: bold;">START TIME</label>
            <input type="datetime-local" id="manual-start">
            <label style="font-size: 0.7rem; color: var(--accent); font-weight: bold;">END TIME</label>
            <input type="datetime-local" id="manual-end">
            <textarea id="manual-pointers" placeholder="Add notes for this manual entry..."></textarea>
            <button class="btn success full-width" onclick="saveManualLog()">Add to History</button>
        </div>
    </div>

    <div id="history-page" class="hidden">
        <div class="dash-card">
            <div class="dash-main">
                <div class="dash-item">
                    <span id="dash-week-total" class="dash-val">0m</span>
                    <span class="dash-lbl">This Week (M-S)</span>
                </div>
                <div class="dash-item" onclick="setDailyGoal()">
                    <span id="dash-goal-val" class="dash-val clickable-item">0m</span>
                    <span class="dash-lbl">Daily Goal üéØ</span>
                </div>
                <div class="dash-item">
                    <span id="dash-streak" class="dash-val">0</span>
                    <span class="dash-lbl">Streak üî•</span>
                </div>
            </div>
            <div class="dash-footer">
                <span id="stat-total-mins">Total: 0m</span>
                <span id="stat-count">Sessions: 0</span>
            </div>
        </div>

        <button class="admin-toggle" onclick="toggleAdminTools()">‚öôÔ∏è Data & Backups</button>
        <div id="admin-tools">
            <button class="btn secondary" style="padding:10px; font-size:0.8rem" onclick="exportToCSV()">üìä Export to CSV</button>
            <button class="btn secondary" style="padding:10px; font-size:0.8rem" onclick="backupJSON()">üíæ Download JSON Backup</button>
            <button class="btn secondary" style="padding:10px; font-size:0.8rem" onclick="document.getElementById('importFile').click()">üìÇ Restore from Backup</button>
            <input type="file" id="importFile" class="hidden" accept=".json" onchange="restoreJSON(event)">
        </div>

        <div id="history-list"></div>
    </div>

    <div id="about-page" class="hidden">
        <h3>User Guide</h3>
        <div style="line-height: 1.7; color: #bbb;">
            <p style="color: var(--text); font-size: 0.95rem; margin-bottom: 25px; opacity: 0.9; line-height: 1.6;">A lightweight tracker for prayer sessions and digital journaling.</p>
            
            <h4 style="color:var(--accent); margin-bottom:5px;">üîí Your Privacy & Data</h4>
            <p>None of your data from this app‚Äîyour notes or your timings‚Äîever leaves your phone or computer. There is no central database and no one (including the developer) can see what you write. It stays 100% on your device, just like a paper journal.</p>
            
            <h4 style="color:var(--accent); margin-bottom:5px;">üéØ Daily Goals & History</h4>
            <p>In <strong>History</strong>, tap the dashed Goal value to set a target. Expand any day using the chevron to see individual sessions. Tap any dashed underline to edit times or durations.</p>
            
            <h4 style="color:var(--accent); margin-bottom:5px;">üì≤ Backups</h4>
            <p>Since data is only on your device, use <strong>JSON Backup</strong> regularly. If you get a new phone or switch browsers, you'll need this file to transfer your history.</p>
        </div>
        <button class="btn secondary full-width" style="margin-top:20px;" onclick="showPage('setup')">Back to App</button>
    </div>
</div>

<script>
    const db = {
        getHistory: () => JSON.parse(localStorage.getItem('prayerHistory') || "[]"),
        saveHistory: (data) => localStorage.setItem('prayerHistory', JSON.stringify(data)),
        getPointers: () => localStorage.getItem('mainPointers') || "",
        savePointers: (txt) => localStorage.setItem('mainPointers', txt),
        getActiveSession: () => JSON.parse(localStorage.getItem('activeSession')),
        setActiveSession: (data) => localStorage.setItem('activeSession', JSON.stringify(data)),
        clearActiveSession: () => localStorage.removeItem('activeSession'),
        getGoal: () => parseInt(localStorage.getItem('dailyGoal') || "0"),
        setGoal: (val) => localStorage.setItem('dailyGoal', val)
    };

    let timerInterval, autosaveInterval, elapsedSeconds = 0, isPaused = false, startTime = null, wakeLock = null;
    let currentlyOpenDay = null; 

    const mainPointersEl = document.getElementById('main-pointers');
    mainPointersEl.value = db.getPointers();
    mainPointersEl.addEventListener('input', () => db.savePointers(mainPointersEl.value));

    window.onload = () => {
        const saved = db.getActiveSession();
        if (saved && saved.startTime) {
            const startDate = new Date(saved.startTime);
            document.getElementById('recovery-timestamp').innerText = `Started: ${startDate.toLocaleDateString()} ${startDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
            const h = Math.floor(saved.elapsed / 3600).toString().padStart(2, '0');
            const m = Math.floor((saved.elapsed % 3600) / 60).toString().padStart(2, '0');
            const s = (saved.elapsed % 60).toString().padStart(2, '0');
            document.getElementById('recovery-details').innerText = `${h}:${m}:${s}`;
            document.getElementById('recovery-overlay').classList.remove('hidden');
        }
    };

    function handleRecovery(choice) {
        const saved = db.getActiveSession();
        document.getElementById('recovery-overlay').classList.add('hidden');
        if (choice === 'resume') {
            startTime = saved.startTime;
            elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
            mainPointersEl.value = saved.pointers;
            startSession(true); 
        } else if (choice === 'save') {
            const history = db.getHistory();
            history.push({ id: Date.now(), start: new Date(saved.startTime).toISOString(), end: new Date().toISOString(), duration: saved.elapsed, pointers: saved.pointers });
            db.saveHistory(history); db.clearActiveSession(); resetTimerUI();
        } else {
            db.clearActiveSession(); resetTimerUI();
        }
    }

    function resetTimerUI() { elapsedSeconds = 0; startTime = null; updateTimerDisplay(); }

    function showPage(pageId) {
        ['setup', 'manual', 'history', 'about'].forEach(id => {
            document.getElementById(id + '-page').classList.add('hidden');
            const btn = document.getElementById('nav-' + id);
            if(btn) btn.classList.remove('active');
        });
        document.getElementById(pageId + '-page').classList.remove('hidden');
        const activeBtn = document.getElementById('nav-' + pageId);
        if(activeBtn) activeBtn.classList.add('active');
        if(pageId === 'history') loadHistory();
        if(pageId === 'manual') prepManualLog();
    }

    async function requestWakeLock() {
        if ('wakeLock' in navigator) {
            try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
        }
    }

    document.addEventListener('visibilitychange', async () => {
        if (wakeLock !== null && document.visibilityState === 'visible') { await requestWakeLock(); }
    });

    function startSession(isResuming = false) {
        if (!isPaused && !isResuming) { startTime = Date.now(); requestWakeLock(); } 
        else if (isPaused) { startTime = Date.now() - (elapsedSeconds * 1000); requestWakeLock(); }
        isPaused = false;
        document.getElementById('start-btn').classList.add('hidden');
        ['pause-btn', 'stop-btn'].forEach(id => document.getElementById(id).classList.remove('hidden'));
        document.getElementById('session-status').innerText = "Session Active";
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => { elapsedSeconds = Math.floor((Date.now() - startTime) / 1000); updateTimerDisplay(); }, 1000);
        if (autosaveInterval) clearInterval(autosaveInterval);
        autosaveInterval = setInterval(() => { db.setActiveSession({ startTime, elapsed: elapsedSeconds, pointers: mainPointersEl.value }); }, 10000);
    }

    function togglePause() {
        if (!isPaused) {
            clearInterval(timerInterval); clearInterval(autosaveInterval);
            isPaused = true; document.getElementById('pause-btn').innerText = "Resume";
            document.getElementById('session-status').innerText = "Paused";
            if (wakeLock) { wakeLock.release().then(() => wakeLock = null); }
        } else {
            document.getElementById('pause-btn').innerText = "Pause"; startSession();
        }
    }

    function stopSession() {
        clearInterval(timerInterval); clearInterval(autosaveInterval);
        if (startTime) {
            const history = db.getHistory();
            history.push({ id: Date.now(), start: new Date(startTime).toISOString(), end: new Date().toISOString(), duration: elapsedSeconds, pointers: mainPointersEl.value });
            db.saveHistory(history);
        }
        db.clearActiveSession();
        if (wakeLock) { wakeLock.release().then(() => wakeLock = null); }
        location.reload(); 
    }


    function updateTimerDisplay() {
        const h = Math.floor(elapsedSeconds / 3600).toString().padStart(2, '0');
        const m = Math.floor((elapsedSeconds % 3600) / 60).toString().padStart(2, '0');
        const s = (elapsedSeconds % 60).toString().padStart(2, '0');
        document.getElementById('display-time').innerText = `${h}:${m}:${s}`;
    }

    function prepManualLog() {
        const now = new Date();
        const fmt = d => new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,16);
        document.getElementById('manual-start').value = fmt(new Date(now - 1800000));
        document.getElementById('manual-end').value = fmt(now);
        document.getElementById('manual-pointers').value = mainPointersEl.value;
    }

    function saveManualLog() {
        const s = new Date(document.getElementById('manual-start').value), e = new Date(document.getElementById('manual-end').value);
        const diff = Math.floor((e - s) / 1000);
        if (diff <= 0) return alert("End time error.");
        const history = db.getHistory();
        history.push({ id: Date.now(), start: s.toISOString(), end: e.toISOString(), duration: diff, pointers: document.getElementById('manual-pointers').value });
        db.saveHistory(history); db.clearActiveSession(); showPage('history');
    }

    function setDailyGoal() {
        const val = prompt("Set daily goal (minutes):", db.getGoal());
        if (val !== null) { db.setGoal(parseInt(val) || 0); loadHistory(); }
    }

    function toggleAdminTools() { document.getElementById('admin-tools').classList.toggle('open'); }

    function calculateStreak(history) {
        if (!history.length) return 0;
        const dates = [...new Set(history.map(h => new Date(h.start).toDateString()))];
        let streak = 0; let checkDate = new Date();
        if (!dates.includes(checkDate.toDateString())) checkDate.setDate(checkDate.getDate() - 1);
        while (dates.includes(checkDate.toDateString())) { streak++; checkDate.setDate(checkDate.getDate() - 1); }
        return streak;
    }

    function formatDuration(totalMins) {
        const mins = Math.round(totalMins);
        if (mins < 60) return mins + "m";
        return `${Math.floor(mins / 60)}h ${mins % 60}m`;
    }

    function loadHistory() {
        let history = db.getHistory().sort((a, b) => new Date(b.start) - new Date(a.start));
        const list = document.getElementById('history-list');
        const goal = db.getGoal();
        list.innerHTML = "";
        
        let totalMins = 0; let weeklyMins = 0;
        let lastYear = null, lastMonth = null;
        
        const now = new Date();
        const startOfWeek = new Date(now);
        startOfWeek.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1));
        startOfWeek.setHours(0,0,0,0);

        const grouped = history.reduce((acc, item) => {
            const dayKey = new Date(item.start).toDateString();
            if (!acc[dayKey]) acc[dayKey] = { items: [], total: 0, date: new Date(item.start) };
            acc[dayKey].items.push(item);
            acc[dayKey].total += (item.duration / 60);
            return acc;
        }, {});

        Object.values(grouped).forEach(day => {
            const d = day.date;
            totalMins += day.total;
            if (d >= startOfWeek) weeklyMins += day.total;

            const year = d.getFullYear();
            const month = d.toLocaleString('default', { month: 'long' });

            if (year !== lastYear) {
                const yEl = document.createElement('div'); yEl.className = "year-head"; yEl.innerText = year;
                list.appendChild(yEl); lastYear = year;
            }
            if (month !== lastMonth || year !== lastYear) {
                const mEl = document.createElement('div'); mEl.className = "month-head"; mEl.innerText = month;
                list.appendChild(mEl); lastMonth = month;
            }

            const dayId = d.getTime();
            const colorClass = (goal > 0 && day.total >= goal) ? 'var(--success)' : (goal > 0 ? '#888' : 'var(--success)');

            const dayEl = document.createElement('div');
            dayEl.className = "history-day-group";
            dayEl.id = `group-${dayId}`;
            dayEl.innerHTML = `
                <div class="day-summary" onclick="toggleDay('${dayId}')">
                    <div><span class="chevron">‚ñ∏</span><span style="font-size:0.95rem">${d.toLocaleDateString([], {day:'numeric', month:'short'})}</span></div>
                    <span style="font-weight:bold; color:${colorClass};">${Math.round(day.total)}m</span>
                </div>
                <div id="day-${dayId}" class="sessions-container">
                    ${day.items.map(item => `
                        <div class="session-item">
                            <div class="session-meta">
                                <span class="clickable-item" onclick="triggerTimePicker(event, ${item.id})">
                                    ${new Date(item.start).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                                </span>
                                <span class="clickable-item" onclick="editDuration(${item.id})">
                                    ${Math.round(item.duration/60)}m
                                </span>
                            </div>
                            <span class="editable-text" contenteditable="true" onblur="updateNotes(${item.id}, this)">${item.pointers || "Tap to add notes..."}</span>
                            <div class="action-bar">
                                <button class="action-btn" onclick="copyText('${item.id}')">üìã Copy</button>
                                <button class="action-btn" style="background:#422;" onclick="deleteItem(${item.id})">üóëÔ∏è Delete</button>
                            </div>
                            <input type="datetime-local" id="picker-${item.id}" class="ghost-input" onchange="saveTimeFromPicker(${item.id}, this)">
                        </div>
                    `).join('')}
                </div>`;
            list.appendChild(dayEl);
        });

        if (currentlyOpenDay) {
            const dayEl = document.getElementById(`day-${currentlyOpenDay}`);
            const groupEl = document.getElementById(`group-${currentlyOpenDay}`);
            if (dayEl && groupEl) {
                dayEl.classList.add('expanded');
                groupEl.classList.add('expanded');
            }
        }

        document.getElementById('dash-streak').innerText = calculateStreak(history);
        document.getElementById('dash-goal-val').innerText = goal + "m";
        document.getElementById('dash-week-total').innerText = formatDuration(weeklyMins);
        document.getElementById('stat-total-mins').innerText = `Total: ${formatDuration(totalMins)}`;
        document.getElementById('stat-count').innerText = `Sessions: ${history.length}`;
    }

    function toggleDay(id) {
        const dayEl = document.getElementById(`day-${id}`);
        const groupEl = document.getElementById(`group-${id}`);
        if (dayEl.classList.contains('expanded')) {
            dayEl.classList.remove('expanded');
            groupEl.classList.remove('expanded');
            currentlyOpenDay = null;
        } else {
            if (currentlyOpenDay) {
                const prevDay = document.getElementById(`day-${currentlyOpenDay}`);
                const prevGrp = document.getElementById(`group-${currentlyOpenDay}`);
                if (prevDay) prevDay.classList.remove('expanded');
                if (prevGrp) prevGrp.classList.remove('expanded');
            }
            dayEl.classList.add('expanded');
            groupEl.classList.add('expanded');
            currentlyOpenDay = id;
        }
    }
    
    function triggerTimePicker(event, id) {
        event.stopPropagation();
        const picker = document.getElementById(`picker-${id}`);
        const history = db.getHistory();
        const item = history.find(h => h.id === id);
        const localDate = new Date(item.start);
        picker.value = new Date(localDate.getTime() - localDate.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
        picker.showPicker();
    }

    function saveTimeFromPicker(id, el) {
        if (!el.value) return;
        const history = db.getHistory();
        const idx = history.findIndex(h => h.id === id);
        history[idx].start = new Date(el.value).toISOString();
        db.saveHistory(history); loadHistory();
    }

    function updateNotes(id, el) {
        const history = db.getHistory();
        const idx = history.findIndex(h => h.id === id);
        if (idx > -1) { history[idx].pointers = el.innerText; db.saveHistory(history); }
    }

    function editDuration(id) {
        const history = db.getHistory();
        const idx = history.findIndex(h => h.id === id);
        const newVal = prompt("Edit session duration (minutes):", Math.round(history[idx].duration/60));
        if (newVal !== null) { history[idx].duration = parseInt(newVal) * 60; db.saveHistory(history); loadHistory(); }
    }

    function deleteItem(id) { if(confirm("Delete session?")) { db.saveHistory(db.getHistory().filter(h => h.id !== id)); loadHistory(); } }
    function copyText(id) { 
        const history = db.getHistory();
        const item = history.find(h => h.id == id);
        navigator.clipboard.writeText(item.pointers).then(() => alert("Copied!")); 
    }

    function backupJSON() {
        const data = { history: db.getHistory(), dailyGoal: db.getGoal(), mainPointers: db.getPointers() };
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify(data)], {type:'application/json'}));
        a.download = `prayer_backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }

    function restoreJSON(e) {
        const file = e.target.files[0];
        if (!file) return;
        const r = new FileReader();
        r.onload = ev => {
            try {
                const imported = JSON.parse(ev.target.result);
                if (imported.history) db.saveHistory(imported.history);
                if (imported.dailyGoal) db.setGoal(imported.dailyGoal);
                if (imported.mainPointers) db.savePointers(imported.mainPointers);
                loadHistory(); 
                alert("Backup restored successfully!");
            } catch (err) {
                alert("Error restoring backup.");
            }
            e.target.value = ''; 
        };
        r.readAsText(file);
    }

    function exportToCSV() {
        const history = db.getHistory();
        let csv = "Date,Duration(Min),Notes\n";
        history.forEach(i => csv += `${new Date(i.start).toLocaleString().replace(/,/g,'')},${Math.round(i.duration/60)},"${(i.pointers || '').replace(/"/g, '""')}"\n`);
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' }));
        a.download = `prayer_log.csv`;
        a.click();
    }
</script>
</body>
</html>
